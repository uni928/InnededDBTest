<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IndexedDB KV サンプル（putData / getData）</title>
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif; line-height:1.6; margin:2rem;}
    .card{max-width:820px; border:1px solid #ddd; border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.06)}
    label{display:block; font-size:.9rem; color:#333; margin:.25rem 0 .25rem}
    input, textarea{width:100%; box-sizing:border-box; padding:.6rem .7rem; border:1px solid #ccc; border-radius:8px; font-family:inherit;}
    textarea{min-height:120px}
    .row{display:flex; gap:.75rem; margin-top:.75rem; flex-wrap:wrap}
    button{padding:.6rem 1rem; border-radius:999px; border:1px solid #ddd; background:#fff; cursor:pointer}
    button.primary{background:#111; color:#fff; border-color:#111}
    .muted{color:#666; font-size:.9rem}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .output{white-space:pre-wrap; background:#f7f7f7; border:1px dashed #ccc; padding:10px; border-radius:8px;}
  </style>
</head>
<body>
  <h1>IndexedDB KV サンプル</h1>
  <p class="muted">シンプルな <span class="mono">putData(key, value)</span> / <span class="mono">getData(key)</span> を提供します。DB名やStore名は決め打ちです。</p>

  <div class="card">
    <label>Key</label>
    <input id="keyInput" placeholder="例：greeting" />

    <label>Value（JSON可。自動で JSON.parse を試行・失敗時は文字列として保存）</label>
    <textarea id="valueInput" placeholder='例："こんにちは" または {"name":"Ichiro","score":99}'></textarea>

    <div class="row">
      <button class="primary" id="saveBtn">putData で保存</button>
      <button id="loadBtn">getData で取得</button>
      <button id="delBtn">deleteData で削除</button>
      <button id="dumpBtn">全キー一覧</button>
    </div>

    <h3>出力</h3>
    <div id="out" class="output">操作結果がここに表示されます。</div>
  </div>

  <script>
    // ======== 設定（決め打ち） ========
    const DB_NAME = 'AppKVDB';        // 適当なDB名
    const DB_VERSION = 1;             // 変更したらonupgradeneededが走る
    const STORE_NAME = 'kv';          // 決め打ちのオブジェクトストア

    // ======== 基本ユーティリティ ========
    function ensureSupport(){
      if(!('indexedDB' in window)){
        throw new Error('このブラウザは IndexedDB をサポートしていません。');
      }
    }

    function openDB(){
      ensureSupport();
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (ev) => {
          const db = req.result;
          // まだストアが無ければ作成
          if(!db.objectStoreNames.contains(STORE_NAME)){
            db.createObjectStore(STORE_NAME, { keyPath: 'key' });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
        req.onblocked = () => console.warn('DB更新がブロックされています。古いタブを閉じてください');
      });
    }

    // 取引(tx)の完了/失敗をPromise化
    function awaitTx(tx, db){
      return new Promise((resolve, reject) => {
        tx.oncomplete = () => { db && db.close(); resolve(); };
        tx.onerror = () => { db && db.close(); reject(tx.error); };
        tx.onabort = () => { db && db.close(); reject(tx.error || new Error('Transaction aborted')); };
      });
    }

    // ======== 公開API ========
    // 任意の値(Structured Clone対応)を保存
    async function putData(key, value){
      if(typeof key !== 'string' || !key) throw new Error('key は非空の文字列で指定してください');
      const db = await openDB();
      const tx = db.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      store.put({ key, value, updatedAt: new Date().toISOString() });
      await awaitTx(tx, db);
    }

    // 値を取得（存在しない場合は undefined を返す）
    async function getData(key){
      if(typeof key !== 'string' || !key) throw new Error('key は非空の文字列で指定してください');
      const db = await openDB();
      const tx = db.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);
      const req = store.get(key);
      const value = await new Promise((resolve, reject) => {
        req.onsuccess = () => resolve(req.result ? req.result.value : undefined);
        req.onerror = () => reject(req.error);
      });
      db.close();
      return value;
    }

    // 便利：削除/全キー
    async function deleteData(key){
      const db = await openDB();
      const tx = db.transaction(STORE_NAME, 'readwrite');
      tx.objectStore(STORE_NAME).delete(key);
      await awaitTx(tx, db);
    }

    async function getAllKeys(){
      const db = await openDB();
      const tx = db.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);
      const req = store.getAllKeys();
      const keys = await new Promise((resolve, reject) => {
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
      db.close();
      return keys;
    }

    // グローバル公開
    window.putData = putData;
    window.getData = getData;
    window.deleteData = deleteData;
    window.getAllKeys = getAllKeys;

    // ======== デモUI ========
    const $ = (sel) => document.querySelector(sel);
    const out = (msg) => { document.getElementById('out').textContent = String(msg); };

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const key = document.getElementById('keyInput').value.trim();
      let raw = document.getElementById('valueInput').value.trim();
      let value;
      if(!raw){ out('値が空です'); return; }
      try{ value = JSON.parse(raw); }
      catch{ value = raw; }
      try{
        await putData(key, value);
        out(`保存しました\nkey: ${key}\nvalue: ${JSON.stringify(value, null, 2)}`);
      }catch(e){ out('保存に失敗: ' + (e && e.message || e)); }
    });

    document.getElementById('loadBtn').addEventListener('click', async () => {
      const key = document.getElementById('keyInput').value.trim();
      try{
        const v = await getData(key);
        out(v === undefined ? `key: ${key} は未登録です` : `取得しました\nkey: ${key}\nvalue: ${JSON.stringify(v, null, 2)}`);
      }catch(e){ out('取得に失敗: ' + (e && e.message || e)); }
    });

    document.getElementById('delBtn').addEventListener('click', async () => {
      const key = document.getElementById('keyInput').value.trim();
      try{ await deleteData(key); out(`削除しました\nkey: ${key}`); }
      catch(e){ out('削除に失敗: ' + (e && e.message || e)); }
    });

    document.getElementById('dumpBtn').addEventListener('click', async () => {
      try{
        const keys = await getAllKeys();
        out('全キー:\n' + keys.join('\n'));
      }catch(e){ out('一覧取得に失敗: ' + (e && e.message || e)); }
    });

    // 起動時にサンプル値を書いてみる（重複時は上書き）
    (async () => {
      try{ await putData('example', { hello: 'world' }); }
      catch(e){ console.warn('初期書き込みでエラー:', e); }
    })();
  </script>
</body>
</html>
